---
name: "PR Terraform Plan"

on:
  pull_request:
      branches: 'main'

jobs:
  dev:
      permissions:
        id-token: write
        contents: read
        pull-requests: write
      runs-on: ubuntu-latest
      env:
        ARM_CLIENT_ID: "${{ secrets.AZURE_CLIENT_ID }}"
        ARM_SUBSCRIPTION_ID: "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
        ARM_TENANT_ID: "${{ secrets.AZURE_TENANT_ID }}"
      steps:                  
          - name: 'Checkout'
            uses: actions/checkout@v4

          - name: 'Setup Terraform'
            uses: hashicorp/setup-terraform@v3
            with:
              cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
              terraform_version: '1.7.3'
          
          - name: Terraform Format
            id: fmt
            run: terraform -chdir=dev fmt  -check -recursive

          - name: Terraform Init
            id: init
            run: terraform -chdir=dev init

          - name: Terraform Validate
            id: validate
            run: terraform validate -no-color

          - name: Terraform get workspace
            id: shows
            run: terraform -chdir=dev workspace show >> $TF_WORKSPACE

          - name: Terraform Plan
            id: plan
            run: terraform -chdir=dev plan
          
          - name: Adding markdown
            env:
              MY_VAR: ${{ steps.plan.outputs.stdout }}
            run: echo $MY_VAR >> $GITHUB_STEP_SUMMARY
          
          - uses: janhartje/terraform-pr-commenter@v2.2
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
              commenter_type: plan
              commenter_input: ${{ format('{0}{1}', steps.plan.outputs.stdout, steps.plan.outputs.stderr) }}
              commenter_exitcode: ${{ steps.plan.outputs.exitcode }}